<!--
/* * Nom de l'application : ATM-RDC
 * Description : Source file: settings.html
 * Produit de : MOA Digital Agency, www.myoneart.com
 * Fait par : Aisance KALONJI, www.aisancekalonji.com
 * Auditer par : La CyberConfiance, www.cyberconfiance.com
 */
-->
{% extends "base.html" %}

{% block title %}Configuration - ATM-RDC{% endblock %}
{% block page_title %}Configuration{% endblock %}
{% block page_subtitle %}Paramètres du système{% endblock %}

{% block content %}
<!-- Macro for rendering fields -->
{% macro render_config_field(config, timezones) %}
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-start border-b border-dark-100 pb-6 last:border-0 last:pb-0">
    <div class="md:col-span-1">
        <label for="{{ config.key }}" class="block text-sm font-medium text-white mb-1">
            {{ config.description or config.key }}
        </label>
        <p class="text-xs text-gray-500 font-mono">{{ config.key }}</p>
        {% if config.category %}
        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-700 text-gray-300 mt-1">
            {{ config.category }}
        </span>
        {% endif %}
    </div>

    <div class="md:col-span-2">
        {% if config.value_type == 'bool' %}
        <select name="{{ config.key }}" id="{{ config.key }}" class="w-full bg-dark-500 border border-dark-100 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-primary-500">
            <option value="true" {% if config.get_typed_value() == True %}selected{% endif %}>Oui</option>
            <option value="false" {% if config.get_typed_value() == False %}selected{% endif %}>Non</option>
        </select>
        {% elif config.value_type == 'file' %}
            {% if config.value %}
            <div class="mb-2">
                <img src="{{ url_for('static', filename=config.value) }}" alt="{{ config.description }}" class="h-12 w-auto object-contain bg-gray-700 rounded p-1">
            </div>
            {% endif %}
            <input type="file" name="{{ config.key }}" id="{{ config.key }}"
                   class="w-full bg-dark-500 border border-dark-100 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-primary-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary-600 file:text-white hover:file:bg-primary-700">
        {% elif config.value_type == 'select' %}
            <select name="{{ config.key }}" id="{{ config.key }}" class="w-full bg-dark-500 border border-dark-100 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-primary-500">
                {% if config.key == 'timezone' %}
                    {% for tz in timezones %}
                    <option value="{{ tz }}" {% if config.value == tz %}selected{% endif %}>{{ tz }}</option>
                    {% endfor %}
                {% elif config.key == 'unit_altitude' %}
                    <option value="ft" {% if config.value == 'ft' %}selected{% endif %}>Pieds (ft)</option>
                    <option value="m" {% if config.value == 'm' %}selected{% endif %}>Mètres (m)</option>
                {% elif config.key == 'unit_speed' %}
                    <option value="kts" {% if config.value == 'kts' %}selected{% endif %}>Nœuds (kts)</option>
                    <option value="km/h" {% if config.value == 'km/h' %}selected{% endif %}>Kilomètres/heure (km/h)</option>
                    <option value="mach" {% if config.value == 'mach' %}selected{% endif %}>Mach</option>
                {% elif config.key == 'invoice_currency' %}
                    <option value="USD" {% if config.value == 'USD' %}selected{% endif %}>USD ($)</option>
                    <option value="EUR" {% if config.value == 'EUR' %}selected{% endif %}>EUR (€)</option>
                    <option value="CDF" {% if config.value == 'CDF' %}selected{% endif %}>CDF (FC)</option>
                {% else %}
                    <option value="{{ config.value }}" selected>{{ config.value }}</option>
                {% endif %}
            </select>
        {% elif config.value_type == 'text' %}
             <textarea name="{{ config.key }}" id="{{ config.key }}" rows="3"
                   class="w-full bg-dark-500 border border-dark-100 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-primary-500">{{ config.value }}</textarea>
        {% elif config.value_type == 'int' %}
            <input type="number" name="{{ config.key }}" id="{{ config.key }}" value="{{ config.value }}"
                   class="w-full bg-dark-500 border border-dark-100 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-primary-500">
        {% else %}
        <input type="text" name="{{ config.key }}" id="{{ config.key }}" value="{{ config.value }}"
               class="w-full bg-dark-500 border border-dark-100 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-primary-500">
        {% endif %}
    </div>
</div>
{% endmacro %}

<div class="bg-dark-400 rounded-xl border border-dark-100 overflow-hidden">
    <div class="p-6 border-b border-dark-100 flex justify-between items-center flex-wrap gap-4">
        <h3 class="font-semibold text-white">
            <i class="fas fa-cogs mr-2 text-primary-400"></i>
            Paramètres Généraux
        </h3>

        <!-- Tabs Header -->
        <div class="flex space-x-2">
            <button type="button" data-tab-target="#general" class="tab-btn px-4 py-2 rounded-lg text-sm font-medium transition-colors bg-primary-600 text-white">
                Général
            </button>
            <button type="button" data-tab-target="#billing" class="tab-btn px-4 py-2 rounded-lg text-sm font-medium transition-colors bg-dark-300 text-gray-400 hover:bg-dark-200">
                Facturation
            </button>
            <button type="button" data-tab-target="#units" class="tab-btn px-4 py-2 rounded-lg text-sm font-medium transition-colors bg-dark-300 text-gray-400 hover:bg-dark-200">
                Unités & Affichage
            </button>
            <button type="button" data-tab-target="#system" class="tab-btn px-4 py-2 rounded-lg text-sm font-medium transition-colors bg-dark-300 text-gray-400 hover:bg-dark-200">
                Système
            </button>
        </div>
    </div>

    <form method="POST" class="p-6" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

        <!-- Tab: General -->
        <div id="general" class="tab-content space-y-6">
            <h4 class="text-lg font-medium text-white mb-4 border-b border-gray-700 pb-2">Paramètres Système & Branding</h4>
            {% for config in configs %}
                {% if config.category in ['branding', 'system'] and config.key != 'timezone' %}
                    {{ render_config_field(config, timezones) }}
                {% endif %}
            {% endfor %}
        </div>

        <!-- Tab: Billing -->
        <div id="billing" class="tab-content space-y-6" style="display: none;">
            <h4 class="text-lg font-medium text-white mb-4 border-b border-gray-700 pb-2">Configuration de la Facturation</h4>
            <div class="grid grid-cols-1 gap-6 mb-6">
                 <p class="text-sm text-gray-400">Définissez ici les éléments visuels et les règles de facturation.</p>
            </div>

            {% for config in configs %}
                {% if config.category == 'invoice' %}
                    {{ render_config_field(config, timezones) }}
                {% endif %}
            {% endfor %}
        </div>

        <!-- Tab: Units -->
        <div id="units" class="tab-content space-y-6" style="display: none;">
             <h4 class="text-lg font-medium text-white mb-4 border-b border-gray-700 pb-2">Unités de Mesure & Affichage</h4>
            {% for config in configs %}
                {% if config.category == 'display' %}
                    {{ render_config_field(config, timezones) }}
                {% endif %}
            {% endfor %}
        </div>

        <!-- Tab: System -->
        <div id="system" class="tab-content space-y-6" style="display: none;">
             <h4 class="text-lg font-medium text-white mb-4 border-b border-gray-700 pb-2">Configuration Système Avancée</h4>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-start border-b border-dark-100 pb-6">
                <div class="md:col-span-1">
                    <label class="block text-sm font-medium text-white mb-1">Espace Aérien</label>
                    <p class="text-xs text-gray-500 font-mono">Configuration Géographique</p>
                </div>
                <div class="md:col-span-2">
                     <a href="{{ url_for('admin.airspace_map') }}" class="inline-flex px-4 py-2 bg-blue-600 text-white hover:bg-blue-500 rounded-lg transition-colors text-sm items-center">
                        <i class="fas fa-map-marked-alt mr-2"></i>
                        Définir Espace Aérien (Carte)
                    </a>
                </div>
            </div>

            {% for config in configs %}
                {% if config.key == 'timezone' %}
                    {{ render_config_field(config, timezones) }}
                {% endif %}
            {% endfor %}

            <!-- Other system configs that don't fit elsewhere -->
            {% for config in configs %}
                {% if config.category not in ['branding', 'system', 'invoice', 'display'] %}
                    {{ render_config_field(config, timezones) }}
                {% endif %}
            {% endfor %}
        </div>

        {% if configs %}
        <div class="mt-8 flex justify-end border-t border-dark-100 pt-6">
            <button type="submit" class="bg-primary-600 hover:bg-primary-700 text-white px-6 py-2 rounded-lg transition-colors flex items-center gap-2">
                <i class="fas fa-save"></i>
                Enregistrer les modifications
            </button>
        </div>
        {% endif %}
    </form>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tabs = document.querySelectorAll('.tab-btn');
    const contents = document.querySelectorAll('.tab-content');

    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            const targetId = tab.dataset.tabTarget;
            const target = document.querySelector(targetId);

            // Deactivate all
            tabs.forEach(t => {
                t.classList.remove('bg-primary-600', 'text-white');
                t.classList.add('bg-dark-300', 'text-gray-400');
            });
            contents.forEach(c => c.style.display = 'none');

            // Activate current
            tab.classList.remove('bg-dark-300', 'text-gray-400');
            tab.classList.add('bg-primary-600', 'text-white');
            if (target) {
                target.style.display = 'block';
            }
        });
    });
});
</script>
{% endblock %}
