{% extends "base.html" %}

{% block title %}Survols - ATM-RDC{% endblock %}
{% block page_title %}Survols & Geofencing{% endblock %}
{% block page_subtitle %}Détection des survols de l'espace aérien RDC{% endblock %}

{% block content %}
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
    <div class="bg-dark-400 rounded-xl border border-dark-100 p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-400 text-sm mb-1">Survols Actifs</p>
                <p class="text-3xl font-bold text-white">{{ active_overflights|length }}</p>
            </div>
            <div class="w-12 h-12 rounded-lg bg-green-500/20 flex items-center justify-center">
                <i class="fas fa-plane text-green-400 text-xl"></i>
            </div>
        </div>
    </div>
    
    <div class="bg-dark-400 rounded-xl border border-dark-100 p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-400 text-sm mb-1">Complétés Aujourd'hui</p>
                <p class="text-3xl font-bold text-white">{{ completed_overflights|length }}</p>
            </div>
            <div class="w-12 h-12 rounded-lg bg-blue-500/20 flex items-center justify-center">
                <i class="fas fa-check-circle text-blue-400 text-xl"></i>
            </div>
        </div>
    </div>
    
    <div class="bg-dark-400 rounded-xl border border-dark-100 p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-400 text-sm mb-1">Non Facturés</p>
                <p class="text-3xl font-bold text-white">{{ completed_overflights|selectattr('is_billed', 'false')|list|length }}</p>
            </div>
            <div class="w-12 h-12 rounded-lg bg-yellow-500/20 flex items-center justify-center">
                <i class="fas fa-file-invoice text-yellow-400 text-xl"></i>
            </div>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <div class="bg-dark-400 rounded-xl border border-dark-100 overflow-hidden">
        <div class="p-4 border-b border-dark-100 flex items-center justify-between">
            <h3 class="font-semibold text-white">
                <i class="fas fa-plane mr-2 text-green-400"></i>
                Survols Actifs
            </h3>
            <span class="w-2 h-2 bg-green-400 rounded-full status-dot"></span>
        </div>
        
        <div class="p-4 space-y-3 max-h-96 overflow-y-auto">
            {% for ovf in active_overflights %}
            <div class="p-4 bg-dark-300 rounded-lg border border-green-500/20" data-testid="overflight-active-{{ ovf.id }}">
                <div class="flex items-center justify-between mb-3">
                    <span class="font-medium text-white">{{ ovf.session_id }}</span>
                    <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-green-500/20 text-green-400">
                        <span class="w-1.5 h-1.5 bg-green-400 rounded-full status-dot"></span>
                        Actif
                    </span>
                </div>
                
                <div class="grid grid-cols-2 gap-3 text-sm">
                    <div>
                        <p class="text-gray-400 text-xs">Point d'entrée</p>
                        <p class="text-white">{{ "%.4f"|format(ovf.entry_lat) }}, {{ "%.4f"|format(ovf.entry_lon) }}</p>
                    </div>
                    <div>
                        <p class="text-gray-400 text-xs">Altitude d'entrée</p>
                        <p class="text-white">FL{{ ((ovf.entry_alt or 0) / 100)|int }}</p>
                    </div>
                    <div>
                        <p class="text-gray-400 text-xs">Heure d'entrée</p>
                        <p class="text-white">{{ ovf.entry_time.strftime('%H:%M:%S') if ovf.entry_time else '--:--:--' }}</p>
                    </div>
                    <div>
                        <p class="text-gray-400 text-xs">Durée en cours</p>
                        <p class="text-green-400 font-medium" id="duration-{{ ovf.id }}">Calcul...</p>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="text-center py-8 text-gray-400">
                <i class="fas fa-plane-slash text-4xl mb-3 opacity-50"></i>
                <p>Aucun survol actif</p>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <div class="bg-dark-400 rounded-xl border border-dark-100 overflow-hidden">
        <div class="p-4 border-b border-dark-100 flex items-center justify-between">
            <h3 class="font-semibold text-white">
                <i class="fas fa-history mr-2 text-blue-400"></i>
                Survols Récents
            </h3>
            <a href="{{ url_for('flights.history') }}" class="text-sm text-primary-400 hover:text-primary-300">
                Voir l'historique <i class="fas fa-arrow-right ml-1"></i>
            </a>
        </div>
        
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-dark-300">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Session</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Durée</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Distance</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Statut</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-dark-100">
                    {% for ovf in completed_overflights[:10] %}
                    <tr class="hover:bg-dark-300/50 transition-colors" data-testid="overflight-row-{{ ovf.id }}">
                        <td class="px-4 py-3">
                            <div>
                                <p class="font-medium text-white text-sm">{{ ovf.session_id }}</p>
                                <p class="text-xs text-gray-400">{{ ovf.exit_time.strftime('%d/%m %H:%M') if ovf.exit_time else '-' }}</p>
                            </div>
                        </td>
                        <td class="px-4 py-3 text-white">
                            {{ ((ovf.duration_minutes or 0) / 60)|int }}h {{ ((ovf.duration_minutes or 0) % 60)|int }}m
                        </td>
                        <td class="px-4 py-3 text-white">
                            {{ (ovf.distance_km or 0)|round(1) }} km
                        </td>
                        <td class="px-4 py-3">
                            {% if ovf.is_billed %}
                            <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-green-500/20 text-green-400">
                                Facturé
                            </span>
                            {% else %}
                            <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-yellow-500/20 text-yellow-400">
                                En attente
                            </span>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4" class="px-4 py-8 text-center text-gray-400">
                            Aucun survol récent
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
