{% extends "base.html" %}

{% block title %}{{ t('radar.title') }} - {{ t('app_name') }}{% endblock %}
{% block page_title %}{{ t('radar.live_monitor') }}{% endblock %}
{% block page_subtitle %}{{ t('dashboard.real_time') }} - {{ t('dashboard.rdc_airspace') }}{% endblock %}

{% block head %}
<style>
    #radar-map {
        height: calc(100vh - 220px);
        min-height: 500px;
        border-radius: 12px;
        overflow: hidden;
        transition: height 0.3s ease;
    }

    #radar-map.fullscreen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh !important;
        z-index: 9999;
        border-radius: 0;
    }
    
    .aircraft-marker {
        background: none;
        border: none;
    }
    
    .aircraft-icon {
        transition: all 0.3s ease;
    }
    
    .aircraft-label {
        background: rgba(15, 23, 42, 0.9);
        border: 1px solid rgba(59, 130, 246, 0.5);
        border-radius: 4px;
        padding: 2px 6px;
        font-size: 10px;
        color: white;
        white-space: nowrap;
        margin-top: 2px;
    }
    
    .aircraft-data-tag {
        background: rgba(15, 23, 42, 0.95);
        border: 1px solid rgba(59, 130, 246, 0.4);
        border-radius: 6px;
        padding: 4px 8px;
        font-size: 11px;
        color: white;
        white-space: nowrap;
        line-height: 1.4;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    
    .flight-info-popup .leaflet-popup-content-wrapper {
        background: rgba(15, 23, 42, 0.95);
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 8px;
        color: white;
    }
    
    .flight-info-popup .leaflet-popup-tip {
        background: rgba(15, 23, 42, 0.95);
    }
    
    .weather-legend {
        position: absolute;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
        background: rgba(15, 23, 42, 0.9);
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 11px;
        color: white;
    }
    
    .layer-control {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
        background: rgba(15, 23, 42, 0.95);
        border-radius: 8px;
        padding: 8px;
        display: none;
    }
    
    .layer-control.show {
        display: block;
    }
    
    .layer-control label {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 4px 8px;
        cursor: pointer;
        border-radius: 4px;
        transition: background 0.2s;
    }
    
    .layer-control label:hover {
        background: rgba(255,255,255,0.1);
    }
    
    .altitude-slider {
        -webkit-appearance: none;
        width: 100%;
        height: 6px;
        border-radius: 3px;
        background: linear-gradient(to right, #22c55e, #eab308, #ef4444);
        outline: none;
    }
    
    .altitude-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: white;
        cursor: pointer;
        border: 2px solid #3b82f6;
    }

    /* Radar Scan Effect */
    .radar-scan-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 400; /* Above map tiles, below overlays */
        pointer-events: none;
        overflow: hidden;
        display: none;
    }

    .radar-scan-overlay.active {
        display: block;
    }

    .radar-scan {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 200vw;
        height: 200vw;
        transform: translate(-50%, -50%);
        border-radius: 50%;
        background: conic-gradient(
            from 0deg,
            rgba(59, 130, 246, 0) 0deg,
            rgba(59, 130, 246, 0) 300deg,
            rgba(59, 130, 246, 0.1) 340deg,
            rgba(59, 130, 246, 0.3) 360deg
        );
        animation: radar-spin 8s linear infinite;
        opacity: 0.5;
    }

    @keyframes radar-spin {
        from { transform: translate(-50%, -50%) rotate(0deg); }
        to { transform: translate(-50%, -50%) rotate(360deg); }
    }

    /* SVG Icons */
    .aircraft-icon-svg {
        filter: drop-shadow(0 2px 3px rgba(0,0,0,0.5));
        transition: all 0.3s ease;
    }

    /* Smart Labels */
    .smart-label {
        background: rgba(15, 23, 42, 0.95);
        border: 1px solid rgba(59, 130, 246, 0.4);
        border-radius: 6px;
        padding: 4px 8px;
        color: white;
        white-space: nowrap;
        box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        display: flex;
        flex-direction: column;
        gap: 2px;
        min-width: 80px;
    }

    .smart-label-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 6px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        padding-bottom: 2px;
        margin-bottom: 2px;
    }

    .smart-label-callsign {
        font-weight: 700;
        font-size: 11px;
    }

    .smart-label-logo {
        height: 12px;
        width: auto;
        max-width: 20px;
        object-fit: contain;
    }

    .smart-label-stats {
        display: flex;
        justify-content: space-between;
        font-size: 9px;
        color: #94a3b8;
    }
</style>
{% endblock %}

{% block content %}
<div class="flex gap-6 h-full">
    <div class="flex-1">
        <div class="bg-dark-400 rounded-xl border border-dark-100 overflow-hidden relative">
            <div class="p-4 border-b border-dark-100 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <h3 class="font-semibold text-white">
                        <i class="fas fa-radar mr-2 text-primary-400"></i>
                        {{ t('radar.map_title') }}
                    </h3>
                    <div class="flex items-center gap-2 text-sm">
                        <span class="w-2 h-2 bg-green-400 rounded-full status-dot"></span>
                        <span class="text-green-400" id="flights-count" data-testid="text-flights-count">0 {{ t('radar.flights_active') }}</span>
                    </div>
                    <div class="flex items-center gap-2 text-sm text-gray-400">
                        <i class="fas fa-clock"></i>
                        <span id="last-update" data-testid="text-last-update">--:--:--</span>
                    </div>
                </div>
                
                <div class="flex items-center gap-2">
                    <button onclick="zoomToRDC()" class="px-3 py-1.5 bg-dark-300 text-gray-300 hover:text-white rounded-lg text-sm transition-colors" data-testid="btn-zoom-rdc">
                        <i class="fas fa-globe-africa mr-1"></i> {{ t('radar.zoom_rdc') }}
                    </button>
                    <button onclick="toggleLayerControl()" class="px-3 py-1.5 bg-dark-300 text-gray-300 hover:text-white rounded-lg text-sm transition-colors" data-testid="btn-layers">
                        <i class="fas fa-layer-group mr-1"></i> {{ t('radar.layers') }}
                    </button>
                    <button onclick="toggleWeather()" class="px-3 py-1.5 bg-dark-300 text-gray-300 hover:text-white rounded-lg text-sm transition-colors" id="btn-weather" data-testid="btn-weather">
                        <i class="fas fa-cloud mr-1"></i> {{ t('radar.weather') }}
                    </button>
                    <button onclick="toggleScan()" class="px-3 py-1.5 bg-dark-300 text-gray-300 hover:text-white rounded-lg text-sm transition-colors" id="btn-scan" title="{{ t('radar.scan_effect') }}">
                        <i class="fas fa-satellite-dish mr-1"></i> {{ t('radar.toggle_scan') }}
                    </button>
                    <button onclick="toggleFullscreen()" class="px-3 py-1.5 bg-dark-300 text-gray-300 hover:text-white rounded-lg text-sm transition-colors" id="btn-fullscreen" data-testid="btn-fullscreen">
                        <i class="fas fa-expand mr-1"></i> {{ t('radar.fullscreen') }}
                    </button>
                    <button onclick="refreshFlights()" class="px-3 py-1.5 bg-primary-600 text-white hover:bg-primary-500 rounded-lg text-sm transition-colors" data-testid="btn-refresh">
                        <i class="fas fa-sync-alt mr-1"></i> {{ t('radar.refresh') }}
                    </button>
                </div>
            </div>
            
            <div id="radar-map" data-testid="radar-map">
                <div id="radar-scan-overlay" class="radar-scan-overlay">
                    <div class="radar-scan"></div>
                </div>
            </div>
            
            <!-- Layer Control Panel -->
            <div class="layer-control" id="layer-control">
                <div class="text-white font-medium mb-2 px-2">{{ t('radar.layer_control') }}</div>
                <label>
                    <input type="checkbox" checked id="layer-boundary" onchange="toggleLayer('boundary')">
                    <span class="text-gray-300 text-sm">{{ t('radar.layer_boundary') }}</span>
                </label>
                <label>
                    <input type="checkbox" checked id="layer-airports" onchange="toggleLayer('airports')">
                    <span class="text-gray-300 text-sm">{{ t('radar.layer_airports') }}</span>
                </label>
                <label>
                    <input type="checkbox" checked id="layer-flights" onchange="toggleLayer('flights')">
                    <span class="text-gray-300 text-sm">{{ t('radar.layer_flights') }}</span>
                </label>
                <label>
                    <input type="checkbox" id="layer-weather" onchange="toggleLayer('weather')">
                    <span class="text-gray-300 text-sm">{{ t('radar.layer_weather') }}</span>
                </label>
                <label>
                    <input type="checkbox" id="layer-precipitation" onchange="toggleLayer('precipitation')">
                    <span class="text-gray-300 text-sm">{{ t('radar.layer_precip') }}</span>
                </label>
                <div class="mt-3 px-2">
                    <div class="text-gray-400 text-xs mb-1">{{ t('radar.basemap') }}</div>
                    <select id="basemap-select" onchange="changeBasemap()" class="w-full px-2 py-1 bg-dark-300 border border-dark-100 rounded text-white text-sm">
                        <option value="dark">{{ t('radar.basemap_dark') }}</option>
                        <option value="satellite">{{ t('radar.basemap_satellite') }}</option>
                        <option value="streets">{{ t('radar.basemap_streets') }}</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
    
    <div class="w-80 flex flex-col gap-4">
        <!-- Filters Panel -->
        <div class="bg-dark-400 rounded-xl border border-dark-100 p-4">
            <h4 class="font-semibold text-white mb-4">
                <i class="fas fa-filter mr-2 text-primary-400"></i>
                {{ t('radar.filters') }}
            </h4>
            
            <div class="space-y-4">
                <!-- Search -->
                <div>
                    <label class="block text-sm text-gray-400 mb-2">{{ t('radar.search') }}</label>
                    <input type="text" id="filter-search" placeholder="{{ t('radar.search_placeholder') }}"
                           class="w-full px-3 py-2 bg-dark-300 border border-dark-100 rounded-lg text-white text-sm focus:outline-none focus:ring-2 focus:ring-primary-500"
                           onkeyup="applyFilters()" data-testid="input-search">
                </div>
                
                <!-- Altitude Range -->
                <div>
                    <label class="block text-sm text-gray-400 mb-2">
                        {{ t('flights.altitude') }}: <span id="altitude-value" class="text-white">0 - 45000 ft</span>
                    </label>
                    <div class="flex gap-2 items-center">
                        <span class="text-xs text-gray-500">0</span>
                        <input type="range" id="filter-altitude-min" min="0" max="45000" value="0" step="1000"
                               class="altitude-slider flex-1" onchange="applyFilters()" data-testid="range-altitude-min">
                        <input type="range" id="filter-altitude-max" min="0" max="45000" value="45000" step="1000"
                               class="altitude-slider flex-1" onchange="applyFilters()" data-testid="range-altitude-max">
                        <span class="text-xs text-gray-500">FL450</span>
                    </div>
                </div>
                
                <!-- Operator Filter -->
                <div>
                    <label class="block text-sm text-gray-400 mb-2">{{ t('radar.operator') }}</label>
                    <select id="filter-operator" class="w-full px-3 py-2 bg-dark-300 border border-dark-100 rounded-lg text-white text-sm focus:outline-none focus:ring-2 focus:ring-primary-500"
                            onchange="applyFilters()" data-testid="select-operator">
                        <option value="all">{{ t('radar.all_operators') }}</option>
                    </select>
                </div>
                
                <!-- Status Filter -->
                <div>
                    <label class="block text-sm text-gray-400 mb-2">{{ t('flights.status') }}</label>
                    <div class="space-y-2">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" checked class="w-4 h-4 rounded border-dark-100 bg-dark-300 text-green-500 focus:ring-green-500" 
                                   data-status="in_flight" onchange="applyFilters()" data-testid="checkbox-in-flight">
                            <span class="w-2.5 h-2.5 bg-green-400 rounded-full"></span>
                            <span class="text-sm text-gray-300">{{ t('radar.filter_cruise') }}</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" checked class="w-4 h-4 rounded border-dark-100 bg-dark-300 text-yellow-500 focus:ring-yellow-500" 
                                   data-status="approaching" onchange="applyFilters()" data-testid="checkbox-approaching">
                            <span class="w-2.5 h-2.5 bg-yellow-400 rounded-full"></span>
                            <span class="text-sm text-gray-300">{{ t('radar.filter_approach') }}</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" checked class="w-4 h-4 rounded border-dark-100 bg-dark-300 text-blue-500 focus:ring-blue-500" 
                                   data-status="on_ground" onchange="applyFilters()" data-testid="checkbox-on-ground">
                            <span class="w-2.5 h-2.5 bg-blue-400 rounded-full"></span>
                            <span class="text-sm text-gray-300">{{ t('radar.filter_ground') }}</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" checked class="w-4 h-4 rounded border-dark-100 bg-dark-300 text-primary-500 focus:ring-primary-500" 
                                   data-status="in_rdc" onchange="applyFilters()" data-testid="checkbox-in-rdc">
                            <span class="w-2.5 h-2.5 bg-primary-400 rounded-full"></span>
                            <span class="text-sm text-gray-300">{{ t('radar.filter_rdc') }}</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Legend -->
        <div class="bg-dark-400 rounded-xl border border-dark-100 p-4">
            <h4 class="font-semibold text-white mb-4">
                <i class="fas fa-info-circle mr-2 text-primary-400"></i>
                {{ t('radar.legend') }}
            </h4>
            
            <div class="space-y-3 text-sm">
                <div class="flex items-center gap-3">
                    <i class="fas fa-plane text-green-400" style="transform: rotate(45deg);"></i>
                    <span class="text-gray-300">{{ t('radar.legend_cruise') }}</span>
                </div>
                <div class="flex items-center gap-3">
                    <i class="fas fa-plane-departure text-yellow-400"></i>
                    <span class="text-gray-300">{{ t('radar.legend_climb') }}</span>
                </div>
                <div class="flex items-center gap-3">
                    <i class="fas fa-plane-arrival text-blue-400"></i>
                    <span class="text-gray-300">{{ t('radar.legend_approach') }}</span>
                </div>
                <div class="flex items-center gap-3">
                    <i class="fas fa-plane text-red-400" style="transform: rotate(45deg);"></i>
                    <span class="text-gray-300">{{ t('radar.legend_emergency') }}</span>
                </div>
                <div class="flex items-center gap-3">
                    <i class="fas fa-helicopter text-purple-400"></i>
                    <span class="text-gray-300">{{ t('radar.legend_heli') }}</span>
                </div>
                <div class="flex items-center gap-3">
                    <i class="fas fa-circle text-primary-400 text-xs"></i>
                    <span class="text-gray-300">{{ t('radar.legend_airport') }}</span>
                </div>
            </div>
        </div>
        
        <!-- Active Flights List -->
        <div class="bg-dark-400 rounded-xl border border-dark-100 flex-1 overflow-hidden flex flex-col">
            <div class="p-4 border-b border-dark-100 flex items-center justify-between">
                <h4 class="font-semibold text-white">
                    <i class="fas fa-list mr-2 text-primary-400"></i>
                    {{ t('radar.flights_list') }}
                </h4>
                <span class="text-xs text-gray-400" id="filtered-count" data-testid="text-filtered-count"></span>
            </div>
            
            <div class="flex-1 overflow-y-auto p-2" id="flights-list" data-testid="flights-list">
                <div class="text-center py-8 text-gray-400">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <p class="text-sm">{{ t('common.loading') }}...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const i18n = {
        flights_active: "{{ t('radar.flights_active') }}",
        temp: "{{ t('radar.temp') }}",
        wind: "{{ t('radar.wind') }}",
        flight: "{{ t('flights.flight') }}", // Vol
        altitude: "{{ t('flights.altitude') }}", // Altitude (or Abbr)
        speed: "{{ t('radar.speed_abbr') }}", // Vit/Spd
        heading: "{{ t('radar.heading') }}",
        dep: "{{ t('radar.dep') }}",
        arr: "{{ t('radar.arr') }}",
        in_rdc: "{{ t('radar.in_rdc_airspace') }}",
        no_match: "{{ t('radar.no_match') }}",
        refresh: "{{ t('radar.refresh') }}",
        all_operators: "{{ t('radar.all_operators') }}",
        fullscreen: "{{ t('radar.fullscreen') }}",
        exit_fullscreen: "{{ t('radar.exit_fullscreen') }}"
    };

    // Aircraft SVGs
    const aircraftIcons = {
        jet: `<svg viewBox="0 0 512 512" fill="currentColor"><path d="M427.6 236.8L352 192l0-106.3c0-37.4-30.6-67.7-68.3-67.7s-68.3 30.4-68.3 67.7L215.4 192l-76-44.3 0-25.3c0-8.9-7.2-16-16-16s-16 7.2-16 16l0 35L15.6 205.4C6.1 210.9 0 220.8 0 231.8s6.1 20.9 15.6 26.4l91.8 47.7 0 35c0 8.9 7.2 16 16 16s16-7.2 16-16l0-25.3 76-44.3 0 106.3c0 37.4 30.6 67.7 68.3 67.7s68.3-30.4 68.3-67.7l0-106.3 75.6-44.8c18.6-11 30.3-31 30.3-52.6s-11.7-41.6-30.3-52.6z"/></svg>`,
        prop: `<svg viewBox="0 0 576 512" fill="currentColor"><path d="M400 128l0-16c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 16-176 0c-35.3 0-64 28.7-64 64l0 128c0 35.3 28.7 64 64 64l176 0 0 16c0 17.7 14.3 32 32 32s32-14.3 32-32l0-16 23.4 0c44.2 0 80 35.8 80 80c0 8.8 7.2 16 16 16s16-7.2 16-16c0-61.9-50.1-112-112-112l-23.4 0 0-160L400 128zM368 256l112 0c8.8 0 16-7.2 16-16s-7.2-16-16-16l-112 0 0 32zM32 240c-17.7 0-32 14.3-32 32s14.3 32 32 32l64 0 0-64-64 0z"/></svg>`, // Using a simpler plane icon as placeholder for prop
        heli: `<svg viewBox="0 0 640 512" fill="currentColor"><path d="M349.9 59.5C335.8 52.8 320.1 52.8 306 59.5L13.8 198.5C5.3 202.5 0 211.2 0 220.6c0 9.4 5.3 18.1 13.8 22.1l65.8 31.3c8.3-3.1 17.1-4.9 26.2-5.3L153.2 227l-55-73.4c-5.7-7.6-4.5-18.3 2.7-24.5l26.2-22.6c6.5-5.6 16.3-5.2 22.3 1L200.7 161l254.6 0 51.3-53.5c6-6.1 15.8-6.6 22.3-1l26.2 22.6c7.2 6.2 8.4 16.9 2.7 24.5L502.8 227l47.5 41.7c9.2 .4 17.9 2.2 26.2 5.3l65.8-31.3c8.5-4 13.8-12.7 13.8-22.1c0-9.4-5.3-18.1-13.8-22.1L349.9 59.5zM368 224l0 96 16 0c26.5 0 48 21.5 48 48l0 16 0 32 32 0 0-32c0-8.8 7.2-16 16-16s16 7.2 16 16l0 32c0 17.7-14.3 32-32 32l-32 0 0 16c0 8.8-7.2 16-16 16s-16-7.2-16-16l0-16-64 0 0 16c0 8.8-7.2 16-16 16s-16-7.2-16-16l0-16-48 0c-17.7 0-32-14.3-32-32l0-32c0-8.8 7.2-16 16-16s16 7.2 16 16l0 32 32 0 0-16c0-26.5 21.5-48 48-48l16 0 0-96 32 0z"/></svg>`,
        plane: `<svg viewBox="0 0 576 512" fill="currentColor"><path d="M482.3 192c34.2 0 58.1-12.2 73.7-26.4c8.8-8 16.6-17.8 20-27.7l0 0c2.5-7.4-4-15-11.7-16c-8.8-1.1-17.7-1.5-26.4-1.5c-22.5 0-43.9 3.1-63.7 8.5L343.9 16l-48.4 0c-4.4 0-8 3.6-8 8l0 125.7-93.6 28.6L125 106.8c-3.7-6.9-10.8-11.2-18.6-11.2l-37.1 0c-5.5 0-9.4 5.4-7.7 10.6l21.2 63.6L16 189.2C7.2 192 1.4 200.4 1.4 209.7c0 9.2 5.6 17.4 14.2 20.3l66.9 22.3L61.6 316c-1.7 5.2 2.2 10.6 7.7 10.6l37.1 0c7.8 0 14.9-4.3 18.6-11.2l68.9-71.5 93.6 31.2L287.5 400c0 4.4 3.6 8 8 8l48.4 0 130.3-112.9c19.8 5.4 41.2 8.5 63.7 8.5c8.8 0 17.7-.4 26.4-1.5c7.7-1 14.1-8.6 11.7-16l0 0c-3.4-9.9-11.2-19.7-20-27.7c-15.6-14.2-39.6-26.4-73.7-26.4l-112.5 0-112.5 0z"/></svg>`
    };

    let map;
    let flightsLayer;
    let boundaryLayer;
    let airportsLayer;
    let weatherLayer;
    let precipitationLayer;
    let basemapLayer;
    let flights = [];
    let filteredFlights = [];
    let weatherEnabled = false;
    let weatherTiles = null;
    
    const airports = {{ airports | tojson | safe }};
    
    const basemaps = {
        dark: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
        satellite: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
        streets: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'
    };
    
    function initMap() {
        map = L.map('radar-map', {
            center: [-2.5, 23.5],
            zoom: 5,
            zoomControl: true,
            attributionControl: false
        });
        
        basemapLayer = L.tileLayer(basemaps.dark, { maxZoom: 19 }).addTo(map);
        
        flightsLayer = L.layerGroup().addTo(map);
        boundaryLayer = L.layerGroup().addTo(map);
        airportsLayer = L.layerGroup().addTo(map);
        weatherLayer = L.layerGroup();
        precipitationLayer = L.layerGroup();
        
        loadBoundary();
        loadAirports();
        loadFlights();
        loadWeatherTiles();
        
        // Add zoom listener for dynamic icon scaling
        map.on('zoomend', () => {
            updateFlightsOnMap();
        });

        // Add Immersive Controls on the map
        const ImmersiveControl = L.Control.extend({
            onAdd: function(map) {
                const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                div.style.backgroundColor = 'rgba(15, 23, 42, 0.9)';
                div.style.border = '1px solid rgba(255, 255, 255, 0.2)';

                div.innerHTML = `
                    <a href="#" role="button" title="${i18n.fullscreen}" onclick="toggleFullscreen(); return false;" style="color: white; width: 34px; height: 34px; line-height: 34px; text-align: center; display: block; border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <i class="fas fa-expand"></i>
                    </a>
                    <a href="#" role="button" title="${i18n.scan_effect}" onclick="toggleScan(); return false;" style="color: white; width: 34px; height: 34px; line-height: 34px; text-align: center; display: block;">
                        <i class="fas fa-satellite-dish"></i>
                    </a>
                `;
                return div;
            }
        });

        map.addControl(new ImmersiveControl({ position: 'topright' }));

        setInterval(loadFlights, 10000);
        updateTime();
        setInterval(updateTime, 1000);
    }
    
    function updateTime() {
        const now = new Date();
        document.getElementById('last-update').textContent = now.toLocaleTimeString('fr-FR');
    }
    
    async function loadWeatherTiles() {
        try {
            const response = await fetch('/radar/api/weather/tiles');
            const data = await response.json();
            
            if (data.configured && data.layers) {
                weatherTiles = data.layers;
                
                if (data.layers.clouds) {
                    L.tileLayer(data.layers.clouds, { opacity: 0.5 }).addTo(weatherLayer);
                }
                if (data.layers.precipitation) {
                    L.tileLayer(data.layers.precipitation, { opacity: 0.6 }).addTo(precipitationLayer);
                }
            }
        } catch (e) {
            console.error('Error loading weather tiles:', e);
        }
    }
    
    async function loadBoundary() {
        try {
            const response = await fetch('/radar/api/boundary');
            const boundary = await response.json();
            
            L.geoJSON(boundary, {
                style: {
                    color: '#3b82f6',
                    weight: 2,
                    opacity: 0.8,
                    fillColor: '#3b82f6',
                    fillOpacity: 0.05,
                    dashArray: '5, 5'
                }
            }).addTo(boundaryLayer);
        } catch (e) {
            console.error('Error loading boundary:', e);
        }
    }
    
    function loadAirports() {
        airports.forEach(airport => {
            if (airport.latitude && airport.longitude) {
                const marker = L.circleMarker([airport.latitude, airport.longitude], {
                    radius: 8,
                    fillColor: '#3b82f6',
                    color: '#1e40af',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                });
                
                marker.bindTooltip(`
                    <div class="text-center">
                        <b>${airport.icao_code}</b><br>
                        <span class="text-gray-300">${airport.name}</span><br>
                        <span class="text-gray-400 text-xs">${airport.city || ''}</span>
                    </div>
                `, {
                    permanent: false,
                    direction: 'top',
                    className: 'aircraft-data-tag'
                });
                
                marker.on('click', () => showAirportWeather(airport.icao_code));
                marker.addTo(airportsLayer);
            }
        });
    }
    
    async function showAirportWeather(icao) {
        try {
            const response = await fetch(`/radar/api/weather/airport/${icao}`);
            const data = await response.json();
            
            let content = `<div class="p-3"><b>${icao}</b>`;
            
            if (data.metar && data.metar.raw) {
                content += `<div class="mt-2 text-xs font-mono bg-dark-300 p-2 rounded">${data.metar.raw}</div>`;
                content += `<div class="mt-2 text-sm">
                    <span class="text-gray-400">Cat:</span> <span class="${data.metar.flight_category === 'VFR' ? 'text-green-400' : 'text-yellow-400'}">${data.metar.flight_category || 'N/A'}</span>
                </div>`;
            }
            
            if (data.weather) {
                content += `<div class="mt-2 text-sm">
                    <span class="text-gray-400">${i18n.temp}:</span> ${data.weather.temperature || '-'}°C |
                    <span class="text-gray-400">${i18n.wind}:</span> ${data.weather.wind_speed || '-'} m/s
                </div>`;
            }
            
            content += '</div>';
            
            const airport = airports.find(a => a.icao_code === icao);
            if (airport) {
                L.popup()
                    .setLatLng([airport.latitude, airport.longitude])
                    .setContent(content)
                    .openOn(map);
            }
        } catch (e) {
            console.error('Error loading airport weather:', e);
        }
    }
    
    async function loadFlights() {
        try {
            const response = await fetch('/radar/api/flights');
            flights = await response.json();
            
            updateOperatorFilter();
            applyFilters();
            
            document.getElementById('flights-count').textContent = `${flights.length} ${i18n.flights_active}`;
        } catch (e) {
            console.error('Error loading flights:', e);
        }
    }
    
    function updateOperatorFilter() {
        const select = document.getElementById('filter-operator');
        const operators = [...new Set(flights.map(f => f.aircraft?.operator).filter(Boolean))];
        
        const currentValue = select.value;
        select.innerHTML = `<option value="all">${i18n.all_operators}</option>`;
        operators.forEach(op => {
            select.innerHTML += `<option value="${op}">${op}</option>`;
        });
        select.value = currentValue || 'all';
    }
    
    function applyFilters() {
        const search = document.getElementById('filter-search').value.toLowerCase();
        const altMin = parseInt(document.getElementById('filter-altitude-min').value);
        const altMax = parseInt(document.getElementById('filter-altitude-max').value);
        const operator = document.getElementById('filter-operator').value;
        
        const statusFilters = {
            in_flight: document.querySelector('[data-status="in_flight"]').checked,
            approaching: document.querySelector('[data-status="approaching"]').checked,
            on_ground: document.querySelector('[data-status="on_ground"]').checked
        };
        const inRdcOnly = document.querySelector('[data-status="in_rdc"]').checked;
        
        document.getElementById('altitude-value').textContent = 
            `${altMin.toLocaleString()} - ${altMax.toLocaleString()} ft`;
        
        filteredFlights = flights.filter(flight => {
            if (search && !matchesSearch(flight, search)) return false;
            
            const alt = flight.altitude || 0;
            if (alt < altMin || alt > altMax) return false;
            
            if (operator !== 'all' && flight.aircraft?.operator !== operator) return false;
            
            if (!statusFilters[flight.status]) return false;
            
            if (inRdcOnly && !flight.in_rdc) return false;
            
            return true;
        });
        
        updateFlightsOnMap();
        updateFlightsList();
        
        document.getElementById('filtered-count').textContent = 
            filteredFlights.length !== flights.length ? 
            `${filteredFlights.length}/${flights.length}` : '';
    }
    
    function matchesSearch(flight, search) {
        return (flight.callsign || '').toLowerCase().includes(search) ||
               (flight.flight_number || '').toLowerCase().includes(search) ||
               (flight.aircraft?.operator || '').toLowerCase().includes(search) ||
               (flight.aircraft?.registration || '').toLowerCase().includes(search) ||
               (flight.departure || '').toLowerCase().includes(search) ||
               (flight.arrival || '').toLowerCase().includes(search);
    }
    
    function getAircraftIcon(flight) {
        const alt = flight.altitude || 0;
        const isEmergency = flight.squawk === '7700';

        const type = (flight.aircraft?.type || '').toUpperCase();
        const model = (flight.aircraft?.model || '').toUpperCase();

        const isHeli = type.includes('H') || model.includes('HELI');
        const isJet = model.includes('B7') || model.includes('A3') || model.includes('ERJ') || model.includes('CRJ') || type === 'J';
        const isProp = model.includes('C172') || model.includes('PA28') || model.includes('CESSNA') || model.includes('DH8') || model.includes('ATR');
        
        let svg = aircraftIcons.plane;
        if (isHeli) svg = aircraftIcons.heli;
        else if (isJet) svg = aircraftIcons.jet;
        else if (isProp) svg = aircraftIcons.prop;
        
        let color = '#22c55e';
        if (isEmergency) color = '#ef4444';
        else if (flight.status === 'approaching') color = '#eab308';
        else if (flight.status === 'on_ground') color = '#3b82f6';
        else if (alt < 10000) color = '#38bdf8';
        
        // Base size, scaled by map zoom later via CSS or JS
        let size = 24;
        if (isHeli) size = 20;
        else if (isJet) size = 28;
        
        return { svg, color, size };
    }
    
    function updateFlightsOnMap() {
        flightsLayer.clearLayers();
        
        const zoom = map.getZoom();
        const scaleFactor = Math.max(0.6, Math.min(1.5, zoom / 8));

        filteredFlights.forEach(flight => {
            if (!flight.latitude || !flight.longitude) return;
            
            const { svg, color, size } = getAircraftIcon(flight);
            const rotation = flight.heading || 0;
            const currentSize = size * scaleFactor;
            
            const icon = L.divIcon({
                className: 'aircraft-marker',
                html: `<div class="aircraft-icon-svg" style="transform: rotate(${rotation}deg); color: ${color}; width: ${currentSize}px; height: ${currentSize}px;">
                         ${svg}
                       </div>`,
                iconSize: [currentSize + 20, currentSize + 20],
                iconAnchor: [(currentSize + 20) / 2, (currentSize + 20) / 2]
            });
            
            const marker = L.marker([flight.latitude, flight.longitude], { icon });
            
            const operator = flight.aircraft?.operator || '';
            const iata = flight.aircraft?.airline_iata || '';

            // Smart Label (Logo, Callsign, Stats)
            const logoUrl = iata ? `https://content.airhex.com/content/logos/airlines_${iata}_200_200_s.png` : '';
            const logoImg = logoUrl ? `<img src="${logoUrl}" class="smart-label-logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">` : '';
            const operatorText = `<span style="${logoUrl ? 'display:none' : ''}" class="text-[9px] text-gray-300 truncate max-w-[80px]">${operator}</span>`;

            const smartLabelHtml = `
                <div class="smart-label">
                    <div class="smart-label-header">
                        <div class="smart-label-callsign">${flight.callsign}</div>
                        ${logoImg}
                        ${operatorText}
                    </div>
                    <div class="smart-label-stats">
                        <span><i class="fas fa-tachometer-alt mr-0.5 text-green-400"></i>${Math.round(flight.ground_speed || 0)}</span>
                        <span><i class="fas fa-arrows-alt-v mr-0.5 text-yellow-400"></i>FL${Math.round((flight.altitude || 0) / 100)}</span>
                    </div>
                </div>
            `;

            marker.bindTooltip(smartLabelHtml, {
                permanent: true,
                direction: 'right',
                offset: [currentSize / 2 + 5, 0],
                className: 'leaflet-tooltip-empty' // Use custom class to remove default styles if needed, or override
            });

            // Enhanced Popup
            const popupContent = `
                <div class="p-2">
                    <div class="flex items-center justify-between mb-2">
                        <div class="font-bold text-lg">${flight.callsign}</div>
                        ${iata ? `<img src="${logoUrl}" class="h-6 object-contain" onerror="this.style.display='none'">` : ''}
                    </div>
                    ${operator ? `<div class="text-xs text-primary-400 mb-2 font-semibold">${operator}</div>` : ''}

                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div class="bg-dark-300 p-1.5 rounded"><span class="text-gray-400 block text-xs">${i18n.dep}</span> ${flight.departure || '???'}</div>
                        <div class="bg-dark-300 p-1.5 rounded"><span class="text-gray-400 block text-xs">${i18n.arr}</span> ${flight.arrival || '???'}</div>

                        <div><span class="text-gray-400 text-xs block">Alt</span> ${Math.round(flight.altitude || 0).toLocaleString()} ft</div>
                        <div><span class="text-gray-400 text-xs block">${i18n.speed}</span> ${Math.round(flight.ground_speed || 0)} kts</div>
                        <div><span class="text-gray-400 text-xs block">${i18n.heading}</span> ${Math.round(flight.heading || 0)}°</div>
                        <div><span class="text-gray-400 text-xs block">Squawk</span> ${flight.squawk || '-'}</div>
                    </div>

                    ${flight.aircraft ? `
                    <div class="mt-2 pt-2 border-t border-dark-100 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-400">${flight.aircraft.model || '-'}</span>
                            <span class="font-mono text-gray-300">${flight.aircraft.registration || '-'}</span>
                        </div>
                    </div>
                    ` : ''}
                    ${flight.in_rdc ? `<div class="mt-2 text-xs text-primary-400"><i class="fas fa-check-circle mr-1"></i>${i18n.in_rdc}</div>` : ''}
                </div>
            `;
            
            marker.bindPopup(popupContent, {
                className: 'flight-info-popup',
                maxWidth: 300
            });
            
            marker.addTo(flightsLayer);
        });
    }

    function toggleFullscreen() {
        const mapContainer = document.getElementById('radar-map');
        const btn = document.getElementById('btn-fullscreen');

        mapContainer.classList.toggle('fullscreen');

        if (mapContainer.classList.contains('fullscreen')) {
            btn.innerHTML = `<i class="fas fa-compress mr-1"></i> ${i18n.exit_fullscreen}`;
            btn.classList.add('bg-primary-600', 'text-white');
            btn.classList.remove('bg-dark-300', 'text-gray-300');
        } else {
            btn.innerHTML = `<i class="fas fa-expand mr-1"></i> ${i18n.fullscreen}`;
            btn.classList.remove('bg-primary-600', 'text-white');
            btn.classList.add('bg-dark-300', 'text-gray-300');
        }

        setTimeout(() => {
            map.invalidateSize();
        }, 300);
    }

    function toggleScan() {
        const overlay = document.getElementById('radar-scan-overlay');
        const btn = document.getElementById('btn-scan');

        overlay.classList.toggle('active');

        if (overlay.classList.contains('active')) {
            btn.classList.add('bg-primary-600', 'text-white');
            btn.classList.remove('bg-dark-300', 'text-gray-300');
        } else {
            btn.classList.remove('bg-primary-600', 'text-white');
            btn.classList.add('bg-dark-300', 'text-gray-300');
        }
    }
    
    function updateFlightsList() {
        const container = document.getElementById('flights-list');
        
        if (filteredFlights.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8 text-gray-400">
                    <i class="fas fa-plane-slash text-2xl mb-2"></i>
                    <p class="text-sm">${i18n.no_match}</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = filteredFlights.map(flight => {
            const { color } = getAircraftIcon(flight);
            return `
                <div class="p-3 rounded-lg hover:bg-dark-300 cursor-pointer transition-colors mb-2" 
                     onclick="focusFlight(${flight.latitude}, ${flight.longitude})" 
                     data-testid="flight-item-${flight.id}">
                    <div class="flex items-center justify-between mb-1">
                        <span class="font-medium text-white">${flight.callsign}</span>
                        <div class="flex items-center gap-2">
                            ${flight.in_rdc ? '<i class="fas fa-check-circle text-primary-400 text-xs"></i>' : ''}
                            <span class="w-2 h-2 rounded-full" style="background: ${color}"></span>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 text-xs text-gray-400">
                        <span>${flight.departure || '???'}</span>
                        <i class="fas fa-long-arrow-alt-right"></i>
                        <span>${flight.arrival || '???'}</span>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">
                        FL${Math.round((flight.altitude || 0) / 100)} | ${Math.round(flight.ground_speed || 0)} kts | ${Math.round(flight.heading || 0)}°
                    </div>
                    ${flight.aircraft?.operator ? `<div class="text-xs text-gray-600 mt-1">${flight.aircraft.operator}</div>` : ''}
                </div>
            `;
        }).join('');
    }
    
    function focusFlight(lat, lon) {
        if (lat && lon) {
            map.setView([lat, lon], 8);
        }
    }
    
    function zoomToRDC() {
        map.setView([-2.5, 23.5], 5);
    }
    
    function toggleLayerControl() {
        document.getElementById('layer-control').classList.toggle('show');
    }
    
    function toggleLayer(layer) {
        switch(layer) {
            case 'boundary':
                if (map.hasLayer(boundaryLayer)) map.removeLayer(boundaryLayer);
                else map.addLayer(boundaryLayer);
                break;
            case 'airports':
                if (map.hasLayer(airportsLayer)) map.removeLayer(airportsLayer);
                else map.addLayer(airportsLayer);
                break;
            case 'flights':
                if (map.hasLayer(flightsLayer)) map.removeLayer(flightsLayer);
                else map.addLayer(flightsLayer);
                break;
            case 'weather':
                if (map.hasLayer(weatherLayer)) map.removeLayer(weatherLayer);
                else map.addLayer(weatherLayer);
                break;
            case 'precipitation':
                if (map.hasLayer(precipitationLayer)) map.removeLayer(precipitationLayer);
                else map.addLayer(precipitationLayer);
                break;
        }
    }
    
    function toggleWeather() {
        weatherEnabled = !weatherEnabled;
        const btn = document.getElementById('btn-weather');
        
        if (weatherEnabled) {
            map.addLayer(weatherLayer);
            btn.classList.add('bg-primary-600');
            btn.classList.remove('bg-dark-300');
            document.getElementById('layer-weather').checked = true;
        } else {
            map.removeLayer(weatherLayer);
            btn.classList.remove('bg-primary-600');
            btn.classList.add('bg-dark-300');
            document.getElementById('layer-weather').checked = false;
        }
    }
    
    function changeBasemap() {
        const selected = document.getElementById('basemap-select').value;
        map.removeLayer(basemapLayer);
        basemapLayer = L.tileLayer(basemaps[selected], { maxZoom: 19 }).addTo(map);
    }
    
    function refreshFlights() {
        document.getElementById('btn-refresh').innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> ...';
        loadFlights().then(() => {
            document.getElementById('btn-refresh').innerHTML = `<i class="fas fa-sync-alt mr-1"></i> ${i18n.refresh}`;
        });
    }
    
    document.addEventListener('DOMContentLoaded', initMap);
</script>
{% endblock %}
