<!--
/* * Nom de l'application : ATM-RDC
 * Description : Source file: index.html
 * Produit de : MOA Digital Agency, www.myoneart.com
 * Fait par : Aisance KALONJI, www.aisancekalonji.com
 * Auditer par : La CyberConfiance, www.cyberconfiance.com
 */
-->
{% extends "base.html" %}

{% block title %}Analytics - ATM-RDC{% endblock %}
{% block page_title %}Analytics & Business Intelligence{% endblock %}
{% block page_subtitle %}Tableaux de bord et statistiques{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .chart-container {
        position: relative;
        height: 300px;
    }
</style>
{% endblock %}

{% block content %}
<!-- KPI Cards -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
    <div class="bg-dark-400 rounded-xl border border-dark-100 p-6">
        <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 rounded-lg bg-green-500/20 flex items-center justify-center">
                <i class="fas fa-plane text-green-400 text-xl"></i>
            </div>
            <span class="text-xs text-gray-400">Aujourd'hui</span>
        </div>
        <p class="text-3xl font-bold text-white mb-1" data-testid="text-daily-overflights">{{ daily_overflights }}</p>
        <p class="text-sm text-gray-400">Survols</p>
    </div>
    
    <div class="bg-dark-400 rounded-xl border border-dark-100 p-6">
        <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 rounded-lg bg-blue-500/20 flex items-center justify-center">
                <i class="fas fa-calendar-alt text-blue-400 text-xl"></i>
            </div>
            <span class="text-xs text-gray-400">Ce mois</span>
        </div>
        <p class="text-3xl font-bold text-white mb-1" data-testid="text-monthly-overflights">{{ monthly_overflights }}</p>
        <p class="text-sm text-gray-400">Survols</p>
    </div>
    
    <div class="bg-dark-400 rounded-xl border border-dark-100 p-6">
        <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 rounded-lg bg-yellow-500/20 flex items-center justify-center">
                <i class="fas fa-dollar-sign text-yellow-400 text-xl"></i>
            </div>
            <span class="text-xs text-gray-400">Aujourd'hui</span>
        </div>
        <p class="text-3xl font-bold text-white mb-1" data-testid="text-daily-revenue">${{ "%.2f"|format(daily_revenue) }}</p>
        <p class="text-sm text-gray-400">Revenus</p>
    </div>
    
    <div class="bg-dark-400 rounded-xl border border-dark-100 p-6">
        <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 rounded-lg bg-purple-500/20 flex items-center justify-center">
                <i class="fas fa-chart-line text-purple-400 text-xl"></i>
            </div>
            <span class="text-xs text-gray-400">Ce mois</span>
        </div>
        <p class="text-3xl font-bold text-white mb-1" data-testid="text-monthly-revenue">${{ "%.2f"|format(monthly_revenue) }}</p>
        <p class="text-sm text-gray-400">Revenus</p>
    </div>
</div>

<!-- Additional Stats Row -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
    <div class="bg-dark-400 rounded-xl border border-dark-100 p-5 flex items-center justify-between">
        <div>
            <p class="text-gray-400 text-sm">Revenus Annuels</p>
            <p class="text-2xl font-bold text-green-400" data-testid="text-yearly-revenue">${{ "%.2f"|format(yearly_revenue) }}</p>
        </div>
        <i class="fas fa-trophy text-green-400/50 text-2xl"></i>
    </div>
    
    <div class="bg-dark-400 rounded-xl border border-dark-100 p-5 flex items-center justify-between">
        <div>
            <p class="text-gray-400 text-sm">Total Vols</p>
            <p class="text-2xl font-bold text-white" data-testid="text-total-flights">{{ total_flights }}</p>
        </div>
        <i class="fas fa-plane text-primary-400/50 text-2xl"></i>
    </div>
    
    <div class="bg-dark-400 rounded-xl border border-dark-100 p-5 flex items-center justify-between">
        <div>
            <p class="text-gray-400 text-sm">Compagnies Actives</p>
            <p class="text-2xl font-bold text-white" data-testid="text-active-airlines">{{ active_airlines }}</p>
        </div>
        <i class="fas fa-building text-blue-400/50 text-2xl"></i>
    </div>
    
    <div class="bg-dark-400 rounded-xl border border-dark-100 p-5 flex items-center justify-between">
        <div>
            <p class="text-gray-400 text-sm">Factures en Attente</p>
            <p class="text-2xl font-bold text-yellow-400" data-testid="text-pending-invoices">{{ pending_invoices }}</p>
        </div>
        <i class="fas fa-file-invoice text-yellow-400/50 text-2xl"></i>
    </div>
</div>

<!-- Charts Row -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- Daily Traffic Chart -->
    <div class="bg-dark-400 rounded-xl border border-dark-100 p-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-white">
                <i class="fas fa-chart-line mr-2 text-primary-400"></i>
                Trafic Journalier (30 jours)
            </h3>
            <select id="traffic-period" onchange="updateTrafficChart()" class="bg-dark-300 border border-dark-100 text-white text-sm rounded-lg px-3 py-1" data-testid="select-traffic-period">
                <option value="7">7 jours</option>
                <option value="30" selected>30 jours</option>
                <option value="90">90 jours</option>
            </select>
        </div>
        <div class="chart-container">
            <canvas id="trafficChart" data-testid="chart-traffic"></canvas>
        </div>
    </div>
    
    <!-- Revenue by Type Chart -->
    <div class="bg-dark-400 rounded-xl border border-dark-100 p-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-white">
                <i class="fas fa-chart-pie mr-2 text-primary-400"></i>
                Revenus par Type
            </h3>
        </div>
        <div class="chart-container">
            <canvas id="revenueTypeChart" data-testid="chart-revenue-type"></canvas>
        </div>
    </div>
</div>

<!-- Second Charts Row -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- Revenue by Airline -->
    <div class="bg-dark-400 rounded-xl border border-dark-100 p-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-white">
                <i class="fas fa-chart-bar mr-2 text-primary-400"></i>
                Top 10 Compagnies (Revenus)
            </h3>
        </div>
        <div class="chart-container">
            <canvas id="airlineChart" data-testid="chart-airlines"></canvas>
        </div>
    </div>
    
    <!-- Airport Traffic -->
    <div class="bg-dark-400 rounded-xl border border-dark-100 p-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-white">
                <i class="fas fa-plane-departure mr-2 text-primary-400"></i>
                Trafic par Aéroport
            </h3>
        </div>
        <div class="chart-container">
            <canvas id="airportChart" data-testid="chart-airports"></canvas>
        </div>
    </div>
</div>

<!-- Export Section -->
<div class="bg-dark-400 rounded-xl border border-dark-100 p-6">
    <h3 class="font-semibold text-white mb-4">
        <i class="fas fa-download mr-2 text-primary-400"></i>
        Exportation des Données
    </h3>
    
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
            <label class="block text-sm text-gray-400 mb-2">Type de données</label>
            <select id="export-type" class="w-full bg-dark-300 border border-dark-100 text-white rounded-lg px-3 py-2" data-testid="select-export-type">
                <option value="overflights">Survols</option>
                <option value="invoices">Factures</option>
                <option value="flights">Vols</option>
            </select>
        </div>
        
        <div>
            <label class="block text-sm text-gray-400 mb-2">Date début</label>
            <input type="date" id="export-start" class="w-full bg-dark-300 border border-dark-100 text-white rounded-lg px-3 py-2" data-testid="input-export-start">
        </div>
        
        <div>
            <label class="block text-sm text-gray-400 mb-2">Date fin</label>
            <input type="date" id="export-end" class="w-full bg-dark-300 border border-dark-100 text-white rounded-lg px-3 py-2" data-testid="input-export-end">
        </div>
        
        <div class="flex items-end gap-2">
            <button onclick="exportData('csv')" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-500 transition-colors" data-testid="btn-export-csv">
                <i class="fas fa-file-csv mr-1"></i> CSV
            </button>
            <button onclick="exportData('json')" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-500 transition-colors" data-testid="btn-export-json">
                <i class="fas fa-file-code mr-1"></i> JSON
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let trafficChart, revenueTypeChart, airlineChart, airportChart;
    
    const chartColors = {
        primary: '#3b82f6',
        green: '#22c55e',
        yellow: '#eab308',
        red: '#ef4444',
        purple: '#a855f7',
        blue: '#06b6d4'
    };
    
    async function initCharts() {
        await Promise.all([
            loadTrafficChart(),
            loadRevenueTypeChart(),
            loadAirlineChart(),
            loadAirportChart()
        ]);
    }
    
    async function loadTrafficChart() {
        const days = document.getElementById('traffic-period').value;
        
        try {
            const response = await fetch(`/analytics/api/traffic/daily?days=${days}`);
            const data = await response.json();
            
            const ctx = document.getElementById('trafficChart').getContext('2d');
            
            if (trafficChart) trafficChart.destroy();
            
            trafficChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'Survols',
                        data: data.map(d => d.count),
                        borderColor: chartColors.primary,
                        backgroundColor: chartColors.primary + '20',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#9ca3af' }
                        },
                        y: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#9ca3af' },
                            beginAtZero: true
                        }
                    }
                }
            });
        } catch (e) {
            console.error('Error loading traffic chart:', e);
        }
    }
    
    async function loadRevenueTypeChart() {
        try {
            const response = await fetch('/analytics/api/revenue/by-type');
            const data = await response.json();
            
            const ctx = document.getElementById('revenueTypeChart').getContext('2d');
            
            if (revenueTypeChart) revenueTypeChart.destroy();
            
            const typeLabels = {
                'overflight': 'Survols',
                'landing': 'Atterrissages',
                'parking': 'Stationnement',
                'other': 'Autres'
            };
            
            revenueTypeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(d => typeLabels[d.type] || d.type),
                    datasets: [{
                        data: data.map(d => d.revenue),
                        backgroundColor: [chartColors.primary, chartColors.green, chartColors.yellow, chartColors.purple]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#9ca3af' }
                        }
                    }
                }
            });
        } catch (e) {
            console.error('Error loading revenue type chart:', e);
        }
    }
    
    async function loadAirlineChart() {
        try {
            const response = await fetch('/analytics/api/revenue/by-airline');
            const data = await response.json();
            
            const ctx = document.getElementById('airlineChart').getContext('2d');
            
            if (airlineChart) airlineChart.destroy();
            
            airlineChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.code || d.airline.substring(0, 10)),
                    datasets: [{
                        label: 'Revenus ($)',
                        data: data.map(d => d.revenue),
                        backgroundColor: chartColors.green
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#9ca3af' }
                        },
                        y: {
                            grid: { display: false },
                            ticks: { color: '#9ca3af' }
                        }
                    }
                }
            });
        } catch (e) {
            console.error('Error loading airline chart:', e);
        }
    }
    
    async function loadAirportChart() {
        try {
            const response = await fetch('/analytics/api/airports/traffic');
            const data = await response.json();
            
            const ctx = document.getElementById('airportChart').getContext('2d');
            
            if (airportChart) airportChart.destroy();
            
            airportChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.airport),
                    datasets: [
                        {
                            label: 'Arrivées',
                            data: data.map(d => d.arrivals),
                            backgroundColor: chartColors.primary
                        },
                        {
                            label: 'Départs',
                            data: data.map(d => d.departures),
                            backgroundColor: chartColors.yellow
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#9ca3af' }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { color: '#9ca3af' }
                        },
                        y: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#9ca3af' },
                            beginAtZero: true
                        }
                    }
                }
            });
        } catch (e) {
            console.error('Error loading airport chart:', e);
        }
    }
    
    function updateTrafficChart() {
        loadTrafficChart();
    }
    
    function exportData(format) {
        const type = document.getElementById('export-type').value;
        const start = document.getElementById('export-start').value;
        const end = document.getElementById('export-end').value;
        
        let url = `/analytics/export/${format}?type=${type}`;
        if (start) url += `&start=${start}`;
        if (end) url += `&end=${end}`;
        
        window.location.href = url;
    }
    
    document.addEventListener('DOMContentLoaded', initCharts);
</script>
{% endblock %}
