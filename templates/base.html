<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="{{ t('app_subtitle') }}">
    <title>{% block title %}{{ branding.get('app_name', t('app_name')) }}{% endblock %}</title>
    
    {% if branding.get('favicon_path') %}
    <link rel="icon" href="{{ url_for('static', filename=branding.get('favicon_path')) }}">
    {% endif %}

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        },
                        dark: {
                            100: '#1e293b',
                            200: '#1a2234',
                            300: '#151c2c',
                            400: '#111827',
                            500: '#0f172a',
                            600: '#0c1322',
                            700: '#090f1a',
                            800: '#060b12',
                            900: '#03070a',
                        }
                    }
                }
            }
        }
    </script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .sidebar-item:hover {
            background: rgba(59, 130, 246, 0.1);
        }
        
        .sidebar-item.active {
            background: rgba(59, 130, 246, 0.2);
            border-left: 3px solid #3b82f6;
        }
        
        .card-glow {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.1);
        }
        
        .status-dot {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .aircraft-icon {
            transition: transform 0.3s ease;
        }
        
        .leaflet-container {
            background: #0f172a;
        }
        
        .alert-badge {
            animation: shake 0.5s ease-in-out;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
        }
        
        .gradient-border {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
        }
        
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #1e293b;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
    </style>
    
    {% block head %}{% endblock %}
</head>
<body class="bg-dark-500 text-gray-100 min-h-screen">
    {% if current_user.is_authenticated %}
    <div class="flex h-screen overflow-hidden">
        <aside class="w-64 bg-dark-400 border-r border-dark-100 flex flex-col">
            <div class="p-4 border-b border-dark-100">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg gradient-border flex items-center justify-center overflow-hidden">
                        {% if branding.get('logo_path') %}
                        <img src="{{ url_for('static', filename=branding.get('logo_path')) }}" alt="Logo" class="w-full h-full object-cover">
                        {% else %}
                        <i class="fas fa-plane text-white text-lg"></i>
                        {% endif %}
                    </div>
                    <div>
                        <h1 class="font-bold text-lg text-white">{{ branding.get('app_name', t('app_name')) }}</h1>
                        <p class="text-xs text-gray-400">{{ t('app_title') }}</p>
                    </div>
                </div>
            </div>
            
            <nav class="flex-1 py-4 overflow-y-auto">
                <div class="px-3 mb-2">
                    <span class="text-xs font-semibold text-gray-500 uppercase tracking-wider">{{ t('nav.main') }}</span>
                </div>
                
                <a href="{{ url_for('dashboard.index') }}" class="sidebar-item flex items-center gap-3 px-4 py-3 text-gray-300 hover:text-white transition-colors {% if request.endpoint and 'dashboard' in request.endpoint %}active{% endif %}" data-testid="nav-dashboard">
                    <i class="fas fa-chart-line w-5"></i>
                    <span>{{ t('nav.dashboard') }}</span>
                </a>
                
                <a href="{{ url_for('radar.index') }}" class="sidebar-item flex items-center gap-3 px-4 py-3 text-gray-300 hover:text-white transition-colors {% if request.endpoint and 'radar.index' in request.endpoint %}active{% endif %}" data-testid="nav-radar">
                    <i class="fas fa-satellite-dish w-5"></i>
                    <span>{{ t('nav.live_monitor') }}</span>
                </a>
                
                <a href="{{ url_for('radar.overflights') }}" class="sidebar-item flex items-center gap-3 px-4 py-3 text-gray-300 hover:text-white transition-colors {% if request.endpoint and 'overflight' in request.endpoint %}active{% endif %}" data-testid="nav-overflights">
                    <i class="fas fa-route w-5"></i>
                    <span>{{ t('nav.overflights') }}</span>
                </a>
                
                <a href="{{ url_for('radar.terminal') }}" class="sidebar-item flex items-center gap-3 px-4 py-3 text-gray-300 hover:text-white transition-colors {% if request.endpoint and 'terminal' in request.endpoint %}active{% endif %}" data-testid="nav-terminal">
                    <i class="fas fa-tower-broadcast w-5"></i>
                    <span>{{ t('nav.terminal') }}</span>
                </a>
                
                <div class="px-3 mt-6 mb-2">
                    <span class="text-xs font-semibold text-gray-500 uppercase tracking-wider">{{ t('nav.management') }}</span>
                </div>
                
                <a href="{{ url_for('flights.index') }}" class="sidebar-item flex items-center gap-3 px-4 py-3 text-gray-300 hover:text-white transition-colors {% if request.endpoint and 'flights' in request.endpoint %}active{% endif %}" data-testid="nav-flights">
                    <i class="fas fa-plane-departure w-5"></i>
                    <span>{{ t('nav.flights') }}</span>
                </a>
                
                {% if current_user.role in ['superadmin', 'billing', 'supervisor'] %}
                <a href="{{ url_for('invoices.index') }}" class="sidebar-item flex items-center gap-3 px-4 py-3 text-gray-300 hover:text-white transition-colors {% if request.endpoint and 'invoices' in request.endpoint %}active{% endif %}" data-testid="nav-invoices">
                    <i class="fas fa-file-invoice-dollar w-5"></i>
                    <span>{{ t('nav.invoices') }}</span>
                </a>
                {% endif %}
                
                {% if current_user.role in ['superadmin', 'auditor'] %}
                <div class="px-3 mt-6 mb-2">
                    <span class="text-xs font-semibold text-gray-500 uppercase tracking-wider">{{ t('nav.admin') }}</span>
                </div>
                
                <a href="{{ url_for('admin.index') }}" class="sidebar-item flex items-center gap-3 px-4 py-3 text-gray-300 hover:text-white transition-colors {% if request.endpoint and 'admin.index' in request.endpoint %}active{% endif %}" data-testid="nav-admin">
                    <i class="fas fa-chart-pie w-5"></i>
                    <span>{{ t('nav.overview') }}</span>
                </a>

                <a href="{{ url_for('admin.settings') }}" class="sidebar-item flex items-center gap-3 px-4 py-3 text-gray-300 hover:text-white transition-colors {% if request.endpoint and 'admin.settings' in request.endpoint %}active{% endif %}" data-testid="nav-settings">
                    <i class="fas fa-cogs w-5"></i>
                    <span>{{ t('nav.settings') }}</span>
                </a>

                <a href="{{ url_for('admin.languages') }}" class="sidebar-item flex items-center gap-3 px-4 py-3 text-gray-300 hover:text-white transition-colors {% if request.endpoint and 'admin.languages' in request.endpoint %}active{% endif %}" data-testid="nav-languages">
                    <i class="fas fa-language w-5"></i>
                    <span>{{ t('nav.languages') or 'Langues' }}</span>
                </a>
                
                <a href="{{ url_for('admin.users') }}" class="sidebar-item flex items-center gap-3 px-4 py-3 text-gray-300 hover:text-white transition-colors {% if request.endpoint and 'admin.users' in request.endpoint %}active{% endif %}" data-testid="nav-users">
                    <i class="fas fa-users w-5"></i>
                    <span>{{ t('nav.users') }}</span>
                </a>

                <a href="{{ url_for('admin.roles') }}" class="sidebar-item flex items-center gap-3 px-4 py-3 text-gray-300 hover:text-white transition-colors {% if request.endpoint and 'admin.roles' in request.endpoint %}active{% endif %}" data-testid="nav-roles">
                    <i class="fas fa-user-shield w-5"></i>
                    <span>{{ t('nav.roles') or 'RÃ´les' }}</span>
                </a>
                
                <a href="{{ url_for('admin.audit_logs') }}" class="sidebar-item flex items-center gap-3 px-4 py-3 text-gray-300 hover:text-white transition-colors {% if request.endpoint and 'audit' in request.endpoint %}active{% endif %}" data-testid="nav-audit">
                    <i class="fas fa-clipboard-list w-5"></i>
                    <span>{{ t('nav.audit_logs') }}</span>
                </a>
                {% endif %}
            </nav>
            
            <div class="p-4 border-t border-dark-100">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-primary-600 flex items-center justify-center">
                        <span class="text-white font-semibold">{{ current_user.username[0].upper() }}</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-white truncate">{{ current_user.first_name or current_user.username }}</p>
                        <p class="text-xs text-gray-400 capitalize">{{ current_user.role }}</p>
                    </div>
                    <a href="{{ url_for('auth.logout') }}" class="p-2 text-gray-400 hover:text-red-400 transition-colors" title="{{ t('auth.logout') }}" data-testid="btn-logout">
                        <i class="fas fa-sign-out-alt"></i>
                    </a>
                </div>
            </div>
        </aside>
        
        <main class="flex-1 flex flex-col overflow-hidden">
            <header class="bg-dark-400 border-b border-dark-100 px-6 py-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-xl font-semibold text-white">{% block page_title %}{{ t('dashboard.title') }}{% endblock %}</h2>
                        <p class="text-sm text-gray-400">{% block page_subtitle %}{% endblock %}</p>
                    </div>
                    
                    <div class="flex items-center gap-4">
                        <div class="flex items-center gap-2">
                             <a href="{{ url_for('set_language', lang_code='fr') }}" class="text-sm {% if current_lang == 'fr' %}text-white font-bold{% else %}text-gray-400{% endif %}">FR</a>
                             <span class="text-gray-600">|</span>
                             <a href="{{ url_for('set_language', lang_code='en') }}" class="text-sm {% if current_lang == 'en' %}text-white font-bold{% else %}text-gray-400{% endif %}">EN</a>
                        </div>

                        <div class="flex items-center gap-2 text-sm text-gray-400">
                            <i class="fas fa-clock"></i>
                            <span id="current-time">--:--:--</span>
                            <span>{{ t('common.time_utc') }}</span>
                        </div>
                        
                        <div class="relative" id="notifications-dropdown-container">
                            <button onclick="toggleNotifications()" class="relative p-2 text-gray-400 hover:text-white transition-colors" data-testid="btn-alerts">
                                <i class="fas fa-bell text-lg"></i>
                                <span class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center alert-badge hidden" id="notification-count">0</span>
                            </button>

                            <!-- Dropdown Menu -->
                            <div id="notifications-menu" class="hidden absolute right-0 mt-2 w-80 bg-dark-400 border border-dark-100 rounded-xl shadow-lg overflow-hidden z-50">
                                <div class="p-3 border-b border-dark-100 flex items-center justify-between">
                                    <h3 class="text-sm font-semibold text-white">Notifications</h3>
                                    <button onclick="markAllRead()" class="text-xs text-primary-400 hover:text-primary-300">Tout marquer comme lu</button>
                                </div>
                                <div id="notifications-list" class="max-h-96 overflow-y-auto">
                                    <div class="p-4 text-center text-gray-500 text-sm">Chargement...</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex items-center gap-2 px-3 py-1.5 bg-green-500/20 text-green-400 rounded-full text-sm">
                            <span class="w-2 h-2 bg-green-400 rounded-full status-dot"></span>
                            <span>{{ t('dashboard.system_active') }}</span>
                        </div>
                    </div>
                </div>
            </header>
            
            <div class="flex-1 overflow-y-auto p-6">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                        <div class="mb-4 p-4 rounded-lg {% if category == 'error' %}bg-red-500/20 text-red-400 border border-red-500/30{% elif category == 'success' %}bg-green-500/20 text-green-400 border border-green-500/30{% else %}bg-blue-500/20 text-blue-400 border border-blue-500/30{% endif %}" data-testid="alert-message">
                            <div class="flex items-center gap-2">
                                <i class="fas {% if category == 'error' %}fa-exclamation-circle{% elif category == 'success' %}fa-check-circle{% else %}fa-info-circle{% endif %}"></i>
                                <span>{{ message }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
                
                {% block content %}{% endblock %}
            </div>
        </main>
    </div>
    {% else %}
    {% block auth_content %}{% endblock %}
    {% endif %}
    
    <script>
        function updateTime() {
            const now = new Date();
            const utc = now.toISOString().substr(11, 8);
            const el = document.getElementById('current-time');
            if (el) el.textContent = utc;
        }
        setInterval(updateTime, 1000);
        updateTime();
        
        {% if current_user.is_authenticated %}
        let lastNotificationCount = 0;

        // Request browser notification permission
        if ("Notification" in window && Notification.permission !== "granted") {
            Notification.requestPermission();
        }

        async function updateNotifications() {
            try {
                // Get count
                const countRes = await fetch('/notifications/count');
                const countData = await countRes.json();
                const count = countData.count;

                const countEl = document.getElementById('notification-count');
                if (countEl) {
                    countEl.textContent = count;
                    if (count > 0) {
                        countEl.classList.remove('hidden');
                        countEl.classList.add('flex');
                    } else {
                        countEl.classList.add('hidden');
                        countEl.classList.remove('flex');
                    }
                }

                // If new notifications arrived, show browser notification or toast
                if (count > lastNotificationCount) {
                    fetchRecentNotifications();
                }
                lastNotificationCount = count;

            } catch (e) {
                console.error('Error fetching notifications:', e);
            }
        }

        async function fetchRecentNotifications() {
            try {
                const res = await fetch('/notifications/?unread_only=true&limit=1');
                const data = await res.json();
                if (data.length > 0) {
                    const notif = data[0];
                    showToast(notif);

                    // Browser notification
                    if ("Notification" in window && Notification.permission === "granted") {
                        new Notification(notif.title, {
                            body: notif.message,
                            icon: '/static/img/logo.png' // Adjust if needed
                        });
                    }
                }
            } catch(e) {}
        }

        function showToast(notification) {
            // Create toast element
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 right-4 bg-dark-300 border border-dark-100 p-4 rounded-xl shadow-lg z-50 flex items-start gap-3 max-w-sm transform transition-all duration-300 translate-y-10 opacity-0';
            toast.innerHTML = `
                <div class="text-primary-400 mt-1"><i class="${notification.icon || 'fas fa-info-circle'}"></i></div>
                <div class="flex-1">
                    <h4 class="text-sm font-semibold text-white">${notification.title}</h4>
                    <p class="text-xs text-gray-400 mt-1">${notification.message}</p>
                </div>
                <button onclick="this.parentElement.remove()" class="text-gray-500 hover:text-white"><i class="fas fa-times"></i></button>
            `;
            document.body.appendChild(toast);

            // Animate in
            requestAnimationFrame(() => {
                toast.classList.remove('translate-y-10', 'opacity-0');
            });

            // Remove after 5s
            setTimeout(() => {
                toast.classList.add('translate-y-10', 'opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        async function toggleNotifications() {
            const menu = document.getElementById('notifications-menu');
            const list = document.getElementById('notifications-list');
            menu.classList.toggle('hidden');

            if (!menu.classList.contains('hidden')) {
                // Load notifications
                try {
                    const res = await fetch('/notifications/');
                    const data = await res.json();

                    if (data.length === 0) {
                        list.innerHTML = '<div class="p-4 text-center text-gray-500 text-sm">Aucune notification</div>';
                    } else {
                        list.innerHTML = data.map(n => `
                            <div class="p-3 border-b border-dark-100 hover:bg-dark-300 transition-colors ${n.is_read ? 'opacity-60' : ''}">
                                <div class="flex items-start gap-3">
                                    <div class="text-primary-400 mt-1"><i class="${n.icon || 'fas fa-info-circle'}"></i></div>
                                    <div class="flex-1">
                                        <h4 class="text-sm font-semibold text-white">${n.title}</h4>
                                        <p class="text-xs text-gray-400 mt-1">${n.message}</p>
                                        <div class="flex items-center gap-2 mt-2">
                                            <span class="text-xs text-gray-600">${new Date(n.created_at).toLocaleString()}</span>
                                            ${n.link ? `<a href="${n.link}" class="text-xs text-primary-400 hover:underline">Voir</a>` : ''}
                                        </div>
                                    </div>
                                    ${!n.is_read ? `
                                    <button onclick="markRead(${n.id})" class="text-xs text-primary-400" title="Marquer comme lu"><i class="fas fa-check"></i></button>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('');
                    }
                } catch (e) {
                    list.innerHTML = '<div class="p-4 text-center text-red-400 text-sm">Erreur de chargement</div>';
                }
            }
        }

        async function markRead(id) {
            try {
                await fetch('/notifications/mark-read', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}'},
                    body: JSON.stringify({id: id})
                });
                toggleNotifications(); // Reload list
                updateNotifications(); // Update count
            } catch(e) {}
        }

        async function markAllRead() {
            try {
                await fetch('/notifications/mark-read', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}'},
                    body: JSON.stringify({id: 'all'})
                });
                toggleNotifications();
                updateNotifications();
            } catch(e) {}
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const container = document.getElementById('notifications-dropdown-container');
            const menu = document.getElementById('notifications-menu');
            if (container && !container.contains(e.target) && !menu.classList.contains('hidden')) {
                menu.classList.add('hidden');
            }
        });

        setInterval(updateNotifications, 30000);
        updateNotifications();
        {% endif %}
    </script>
    
    {% block scripts %}{% endblock %}
</body>
</html>
